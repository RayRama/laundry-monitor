<!DOCTYPE html>
<html lang="id" class="h-full bg-gray-50">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Whoooshlab • Smartlink Revenue Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="/styles/dashboard.css" />
  </head>
  <body class="h-full">
    <header
      class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur"
    >
      <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-2 sm:py-3">
        <div class="flex items-center gap-2 sm:gap-3">
          <!-- Logo -->
          <div
            class="w-8 h-8 sm:w-9 sm:h-9 rounded-xl bg-sky-500 flex items-center justify-center text-white font-black text-sm sm:text-base flex-shrink-0"
          >
            WL
          </div>

          <!-- Title Section -->
          <div class="flex-1 min-w-0">
            <h1
              class="text-sm sm:text-base lg:text-lg font-extrabold tracking-tight text-slate-900 truncate"
            >
              <span class="hidden sm:inline"
                >Whoooshlab • Smartlink Revenue Dashboard</span
              >
              <span class="sm:hidden">Smartlink Dashboard</span>
            </h1>
            <p class="text-slate-500 text-xs sm:text-sm -mt-0.5 truncate">
              <span class="hidden sm:inline"
                >Real-time transaction data from Smartlink API</span
              >
              <span class="sm:hidden">Transaction data</span>
            </p>
          </div>

          <!-- Navigation Menu (Admin Only) -->
          <div class="hidden admin-nav flex items-center gap-1 sm:gap-2 mr-2">
            <a href="/monitor" class="btn btn-outline text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2">
              Monitor
            </a>
            <a href="/leaderboard" class="btn btn-outline text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2">
              Leaderboard
            </a>
          </div>

          <!-- Action Buttons -->
          <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
            <!-- Live Badge -->
            <span
              class="pill pill-amber text-xs sm:text-sm hidden sm:inline-flex"
              >Live</span
            >
            <span class="pill pill-amber text-xs sm:inline-flex md:hidden"
              >●</span
            >

            <!-- Export Excel Button -->
            <button
              id="exportExcel"
              class="btn btn-secondary export-btn text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
              title="Export ke Excel"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-3 h-3 sm:w-4 sm:h-4 sm:mr-1"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                />
              </svg>
              <span class="hidden sm:inline">Export Excel</span>
            </button>

            <!-- Refresh Button -->
            <button
              id="refreshData"
              class="btn btn-primary refresh-btn text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-3 h-3 sm:w-4 sm:h-4 sm:mr-1"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                />
              </svg>
              <span class="hidden sm:inline">Refresh</span>
            </button>

            <!-- Logout Button -->
            <button
              class="logout-btn btn btn-secondary text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
              title="Logout"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-3 h-3 sm:w-4 sm:h-4 sm:mr-1"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M16 17v-3H9v-4h7V7l5 5-5 5zM14 2c1.1 0 2 .9 2 2v2h-2V4H4v16h10v-2h2v2c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10z"
                />
              </svg>
              <span class="hidden sm:inline">Logout</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6">
      <!-- Data Range Info -->
      <div id="data-range-info" class="data-range-info">
        <div class="range-text">Memuat data...</div>
        <div class="range-dates">Silakan tunggu sebentar</div>
      </div>

      <!-- Filter Controls -->
      <section class="filter-section">
        <div class="flex items-center justify-between gap-3 mb-4">
          <h2 class="text-slate-900 text-base font-bold">Filter Data</h2>
          <div class="text-xs text-slate-500">
            Data diambil dari Smartlink API secara real-time
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <label for="filterBy">Jenis Filter</label>
            <select id="filterBy" class="w-40">
              <option value="hari_ini">Hari Ini</option>
              <option value="minggu_ini">Minggu Ini</option>
              <option value="bulan_ini">Bulan Ini</option>
              <option value="bulan">Bulan (Custom)</option>
              <option value="tahun">Tahun</option>
              <option value="periode">Rentang Tanggal</option>
            </select>
          </div>

          <div id="bulanGroup" class="filter-group">
            <label for="bulan">Bulan</label>
            <input type="month" id="bulan" class="w-40" />
          </div>

          <div id="tahunGroup" class="filter-group" style="display: none">
            <label for="tahun">Tahun</label>
            <input
              type="number"
              id="tahun"
              min="2020"
              max="2030"
              class="w-24"
            />
          </div>

          <div id="periodeGroup" class="filter-group" style="display: none">
            <label for="tanggalAwal">Tanggal Awal</label>
            <input type="date" id="tanggalAwal" class="w-40" />
          </div>

          <div id="periodeGroup2" class="filter-group" style="display: none">
            <label for="tanggalAkhir">Tanggal Akhir</label>
            <input type="date" id="tanggalAkhir" class="w-40" />
          </div>

          <div class="filter-group">
            <label for="limitType">Limit Data</label>
            <select id="limitType" class="w-32">
              <option value="max">Maksimal</option>
              <option value="100">100</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="custom">Custom</option>
            </select>
          </div>

          <div id="customLimitGroup" class="filter-group" style="display: none">
            <label for="customLimit">Jumlah</label>
            <input
              type="number"
              id="customLimit"
              min="1"
              max="10000"
              value="100"
              class="w-24"
            />
          </div>

          <div class="filter-group">
            <button id="applyFilter" class="btn btn-primary">Terapkan</button>
          </div>

          <div class="filter-group">
            <button id="clearFilter" class="btn btn-secondary">Reset</button>
          </div>
        </div>
      </section>

      <!-- KPIs -->
      <section class="grid-auto">
        <div class="card p-5 kpi">
          <div class="label">Total Omzet</div>
          <div id="kpi-revenue" class="value">–</div>
          <div id="kpi-aov" class="sub">AOV –</div>
        </div>
        <div class="card p-5 kpi">
          <div class="label">Total Transaksi</div>
          <div id="kpi-tx" class="value">–</div>
          <div id="kpi-date-range" class="sub">–</div>
        </div>
        <div class="card p-5 kpi">
          <div class="label">Paid Rate</div>
          <div class="flex items-center gap-2">
            <div id="kpi-paid" class="value">–</div>
            <span class="pill pill-green" id="kpi-paid-pill">–</span>
          </div>
          <div class="sub">Selesai <span id="kpi-finished">–</span></div>
        </div>
        <div class="card p-5 kpi">
          <div class="label">Omzet per Hari</div>
          <div id="kpi-perday" class="value">–</div>
          <div id="kpi-growth" class="sub">Pertumbuhan d/d: –</div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid lg:grid-cols-1 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Omzet Harian</h3>
            <div class="text-xs text-slate-500">
              <span class="legend-dot" style="background: var(--brand)"></span>
              Omzet (IDR)
            </div>
          </div>
          <canvas id="chartDaily" height="120"></canvas>
        </div>
      </section>

      <!-- Additional Charts -->
      <section class="grid lg:grid-cols-2 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Omzet Mingguan</h3>
            <div class="text-xs text-slate-500">
              <span class="legend-dot" style="background: var(--brand)"></span>
              Omzet per Minggu (IDR)
            </div>
          </div>
          <canvas id="chartWeekly" height="120"></canvas>
        </div>
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Transaksi Harian</h3>
            <div class="text-xs text-slate-500">
              <span class="legend-dot" style="background: var(--accent)"></span>
              Jumlah Transaksi
            </div>
          </div>
          <canvas id="chartTransactionDaily" height="120"></canvas>
        </div>
      </section>

      <!-- Combined Chart -->
      <section class="grid lg:grid-cols-1 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Omzet & Transaksi Harian</h3>
            <div class="text-xs text-slate-500 flex items-center gap-4">
              <span class="flex items-center gap-1">
                <span
                  class="legend-dot"
                  style="background: var(--brand)"
                ></span>
                Omzet (IDR)
              </span>
              <span class="flex items-center gap-1">
                <span
                  class="legend-dot"
                  style="background: var(--accent)"
                ></span>
                Transaksi
              </span>
            </div>
          </div>
          <canvas id="chartCombined" height="120"></canvas>
        </div>
      </section>

      <section class="grid lg:grid-cols-1 gap-4">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Transaksi per Jam</h3>
            <div class="text-xs text-slate-500">
              <span class="legend-dot" style="background: var(--accent)"></span>
              Jumlah Tx
            </div>
          </div>
          <canvas id="chartHourly" height="200"></canvas>
        </div>
        <div class="card p-4 overflow-x-auto">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-slate-900 font-bold">Heat • Hari × Jam</h3>
            <div class="text-xs text-slate-500">
              Kepadatan transaksi (jumlah)
            </div>
          </div>
          <div id="heatWrap" class="min-w-[800px]"></div>
        </div>
      </section>

      <!-- Table -->
      <section class="card p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-slate-900 font-bold">Transaksi Terbaru</h3>
          <div class="text-sm text-slate-500">Maks. 100 baris</div>
        </div>
        <div class="overflow-auto max-h-[440px]">
          <table class="table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Jam</th>
                <th>ID Transaksi</th>
                <th>Jenis</th>
                <th>Customer</th>
                <th>Nominal</th>
                <th>Paid</th>
                <th>Selesai</th>
              </tr>
            </thead>
            <tbody id="txBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Shift Transaction Card -->
      <section class="card p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-slate-900 font-bold">Transaksi per Shift</h3>
          <button
            id="refreshShiftData"
            class="btn btn-secondary btn-small"
            style="padding: 0.5rem 1rem; font-size: 0.9rem"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 0.5rem"
            >
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              />
            </svg>
            Refresh Shift
          </button>
        </div>

        <div class="shift-filter-section" style="margin-bottom: 1.5rem">
          <div class="filter-group">
            <label for="shiftDatePicker" style="font-size: 0.9rem; font-weight: 500; color: #64748b; margin-bottom: 0.5rem; display: block">
              Tanggal:
            </label>
            <input
              type="date"
              id="shiftDatePicker"
              class="shift-date-input"
              style="padding: 0.5rem 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.9rem; background: white; color: #1e293b; transition: border-color 0.2s ease; width: 100%; max-width: 200px"
            />
          </div>
        </div>

        <div class="shift-transactions-display">
          <div class="shift-item">
            <div class="shift-header">
              <span class="shift-label">Shift 1</span>
              <span class="shift-time">06:00 - 14:00</span>
            </div>
            <div class="shift-count" id="shift1Count">0 transaksi</div>
            <div class="shift-revenue" id="shift1Revenue">Rp 0</div>
          </div>
          <div class="shift-item">
            <div class="shift-header">
              <span class="shift-label">Shift 2</span>
              <span class="shift-time">14:01 - 21:59</span>
            </div>
            <div class="shift-count" id="shift2Count">0 transaksi</div>
            <div class="shift-revenue" id="shift2Revenue">Rp 0</div>
          </div>
          <div class="shift-item">
            <div class="shift-header">
              <span class="shift-label">Shift 3</span>
              <span class="shift-time">22:00 - 05:59</span>
            </div>
            <div class="shift-count" id="shift3Count">0 transaksi</div>
            <div class="shift-revenue" id="shift3Revenue">Rp 0</div>
          </div>
        </div>
        <div class="shift-loading" id="shiftLoading" style="display: none; text-align: center; padding: 1rem; color: #64748b; font-size: 0.9rem">
          Memuat data...
        </div>
      </section>

      <!-- How to -->
      <section class="prose max-w-none">
        <div class="card p-5">
          <h3 class="text-slate-900 font-bold mb-2">Cara Pakai</h3>
          <ol class="list-decimal pl-5 space-y-1 text-slate-700">
            <li>
              Dashboard akan otomatis memuat data transaksi dari Smartlink API
              saat pertama kali dibuka.
            </li>
            <li>
              Gunakan <b>Filter Data</b> untuk mengubah periode data yang
              ditampilkan (bulan, tahun, atau periode tertentu).
            </li>
            <li>
              Atur <b>Limit Data</b> untuk membatasi jumlah transaksi yang
              diambil (maksimal, 100, 500, 1000, atau custom).
            </li>
            <li>Klik <b>Refresh</b> untuk memuat data terbaru dari API.</li>
            <li>
              Semua KPI dan grafik akan otomatis terupdate sesuai filter yang
              dipilih.
            </li>
          </ol>
          <p class="footer-note mt-4">
            <strong>Catatan:</strong> Data diambil secara real-time dari
            Smartlink API. Pastikan koneksi internet stabil untuk performa
            optimal.
          </p>
        </div>
      </section>

      <footer class="py-6 text-center text-sm text-slate-500">
        &copy; 2025 • Whoooshlab Analytics • Powered by Smartlink API
      </footer>
    </main>

    <script src="/scripts/auth.js"></script>
    <script src="/scripts/dashboard.js"></script>
    <script>
      // Require admin access and show navigation menu
      document.addEventListener('DOMContentLoaded', function() {
        // Check admin access first
        if (!Auth.requireAdmin()) {
          return; // Will redirect if not admin
        }

        // Show admin navigation menu
        const adminNav = document.querySelector('.admin-nav');
        if (adminNav) {
          adminNav.classList.remove('hidden');
        }
      });
    </script>
  </body>
</html>
